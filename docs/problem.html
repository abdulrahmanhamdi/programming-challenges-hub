<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Problem Viewer | Coding Hub</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">

    <link rel="stylesheet" href="assets/css/global.css">
    <link rel="stylesheet" href="assets/css/theme.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/markdown.css">
    <link rel="stylesheet" href="assets/css/code.css"> 

    <style>
        /* Page Specific: Adjust for Sidebar */
        @media (min-width: 992px) {
            body { padding-left: 260px; }
            #sidebar { left: 0; }
        }
        /* Mobile Sidebar hidden by default */
        @media (max-width: 991px) {
            #sidebar { display: none; } 
        }
    </style>
</head>

<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Coding Hub</a>
            
            <div class="d-flex align-items-center gap-2 ms-auto">
                <a href="problems.html" class="btn btn-sm btn-outline-light d-lg-none">List</a>
                <button class="btn btn-light btn-sm" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
            </div>
        </div>
    </nav>

    <div id="sidebar" class="bg-white border-end" style="position: fixed; top: 0; bottom: 0; width: 260px; overflow-y: auto; padding-top: 60px; z-index: 1000;">
        <div class="p-3">
            <h6 class="text-uppercase text-muted fw-bold mb-3" style="font-size: 0.8rem;">Problem List</h6>
            <div id="sidebarList" class="list-group list-group-flush">
                <div class="text-center text-muted small">Loading...</div>
            </div>
        </div>
    </div>

    <div class="container mt-4 mb-5 animate-fade" style="max-width: 900px;">

        <div class="d-flex justify-content-between align-items-start border-bottom pb-3 mb-4">
            <div>
                <h2 id="problemTitleDisplay" class="fw-bold mb-2">Loading...</h2>
                <span id="difficultyBadge" class="badge bg-secondary">...</span>
            </div>
            <button id="favButton" class="fav-btn fs-3" title="Add to Favorites">‚òÖ</button>
        </div>

        <div id="problemContent"></div>

        <div class="card bg-light border-0 mt-5">
            <div class="card-body d-flex justify-content-between align-items-center">
                <span class="text-muted">Stuck? Check the solution.</span>
                <a id="solutionLink" href="#" class="btn btn-success">
                    View Solution <span class="ms-1">‚Üí</span>
                </a>
            </div>
        </div>

        <hr class="my-5">

        <div class="d-flex justify-content-between">
            <button id="prevBtn" class="btn btn-outline-secondary">‚Üê Previous Problem</button>
            <button id="nextBtn" class="btn btn-outline-secondary">Next Problem ‚Üí</button>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/core.js"></script>
    <script src="assets/js/favorites.js"></script>

    <script>
        // Global Variables
        let PROBLEMS = [];
        let CURRENT_INDEX = -1;

        // Get ID from URL (e.g. "problems/easy/two-sum.md")
        const urlParams = new URLSearchParams(window.location.search);
        const problemPath = urlParams.get('id');

        // 1. Initialize Page
        async function init() {
            if (!problemPath) {
                document.getElementById("problemContent").innerHTML = `<div class="alert alert-warning">No problem selected. <a href="problems.html">Go back to list</a>.</div>`;
                document.getElementById("problemTitleDisplay").innerText = "Not Found";
                return;
            }

            // Fetch Index (for Sidebar & Nav) AND Problem Content
            try {
                await Promise.all([loadIndex(), loadContent()]);
            } catch (error) {
                console.error(error);
            }
        }

        // 2. Load Problems Index (Sidebar + Prev/Next Logic)
        async function loadIndex() {
            const res = await fetch(CONFIG.PROBLEMS_INDEX); // Uses config.js path
            const text = await res.text();
            
            const lines = text.split("\n").filter(l => l.startsWith("| ") && l.includes(".md"));
            
            PROBLEMS = lines.map((line, index) => {
                const parts = line.split("|");
                return {
                    index: index,
                    title: parts[1].trim(),
                    difficulty: parts[2].trim().toLowerCase(),
                    link: parts[3].match(/\((.*)\)/)[1], // problems/easy/xyz.md
                    slug: parts[3].match(/\((.*)\)/)[1].split("/").pop().replace(".md", "")
                };
            });

            // Render Sidebar
            const sidebar = document.getElementById("sidebarList");
            sidebar.innerHTML = "";
            PROBLEMS.forEach(p => {
                const activeClass = (p.link === problemPath) ? "active" : "";
                sidebar.innerHTML += `
                    <a href="problem.html?id=${p.link}" class="list-group-item list-group-item-action ${activeClass} small py-2">
                        ${p.title}
                    </a>`;
            });

            // Setup Prev/Next
            CURRENT_INDEX = PROBLEMS.findIndex(p => p.link === problemPath);
            updateNavButtons();
            
            // Setup Solution Link
            if (CURRENT_INDEX !== -1) {
                const currentProb = PROBLEMS[CURRENT_INDEX];
                document.getElementById("solutionLink").href = `solution.html?slug=${currentProb.slug}`;
                
                // Update Badge
                const badge = document.getElementById("difficultyBadge");
                badge.innerText = currentProb.difficulty;
                badge.className = `badge ${currentProb.difficulty === 'easy' ? 'bg-success' : currentProb.difficulty === 'medium' ? 'bg-warning text-dark' : 'bg-danger'}`;

                // Setup Favorites
                setupFavButtonInPage(currentProb);
            }
        }

        // 3. Load Markdown Content
        async function loadContent() {
            // problemPath is like "problems/easy/file.md". We are in "docs/".
            // So we need "../problems/easy/file.md"
            const fetchPath = "../" + problemPath;

            try {
                const res = await fetch(fetchPath);
                if (!res.ok) throw new Error("File not found");
                const md = await res.text();

                // Render Markdown
                const html = marked.parse(md);
                const contentDiv = document.getElementById("problemContent");
                contentDiv.innerHTML = html;

                // Extract Title from MD (First H1)
                const titleMatch = md.match(/^# (.*$)/m);
                if (titleMatch) {
                    document.getElementById("problemTitleDisplay").innerText = titleMatch[1];
                }

                // Highlight Code
                document.querySelectorAll("pre code").forEach(el => hljs.highlightElement(el));

                // Add Copy Buttons
                addCopyButtons();

            } catch (e) {
                document.getElementById("problemContent").innerHTML = `<div class="alert alert-danger">Error loading problem file: ${e.message}</div>`;
            }
        }

        // 4. Navigation Logic
        function updateNavButtons() {
            const prevBtn = document.getElementById("prevBtn");
            const nextBtn = document.getElementById("nextBtn");

            prevBtn.disabled = (CURRENT_INDEX <= 0);
            nextBtn.disabled = (CURRENT_INDEX >= PROBLEMS.length - 1);

            prevBtn.onclick = () => location.href = `problem.html?id=${PROBLEMS[CURRENT_INDEX - 1].link}`;
            nextBtn.onclick = () => location.href = `problem.html?id=${PROBLEMS[CURRENT_INDEX + 1].link}`;
        }

        // 5. Helper: Add Copy Buttons
        function addCopyButtons() {
            document.querySelectorAll("pre").forEach(pre => {
                // Wrapper for positioning
                const wrapper = document.createElement("div");
                wrapper.style.position = "relative";
                pre.parentNode.insertBefore(wrapper, pre);
                wrapper.appendChild(pre);

                const btn = document.createElement("button");
                btn.className = "copy-btn"; // Defined in components.css or code.css
                btn.innerText = "Copy";
                btn.style.position = "absolute";
                btn.style.top = "5px";
                btn.style.right = "5px";
                
                btn.onclick = () => {
                    navigator.clipboard.writeText(pre.innerText);
                    btn.innerText = "Copied!";
                    setTimeout(() => btn.innerText = "Copy", 1500);
                };
                wrapper.appendChild(btn);
            });
        }

        // 6. Helper: Favorites
        function setupFavButtonInPage(problemObj) {
            const btn = document.getElementById("favButton");
            
            // Check status
            if (isFavorite(problemObj.slug)) {
                btn.classList.add("active");
            }

            btn.onclick = () => {
                toggleFavorite(problemObj); // function from favorites.js
                btn.classList.toggle("active");
            };
        }

        // Start
        init();

    </script>
</body>
</html>